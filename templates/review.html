<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Review - AutoSocioly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .review-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .image-preview {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .image-comparison {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .image-container {
            flex: 1;
            min-width: 300px;
            text-align: center;
        }
        .image-container h5 {
            margin-bottom: 1rem;
            color: #495057;
            font-weight: 600;
        }
        .image-actions {
            margin-top: 1rem;
        }
        .hashtag-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            margin: 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .platform-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }
        .enhanced-prompt {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 1.5rem;
            border-left: 4px solid #2196f3;
        }
        .action-buttons {
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .analytics-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .analytics-metric {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .analytics-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .improvement-item {
            border-left: 3px solid #28a745;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .improvement-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>AutoSocioly
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-eye me-1"></i>Review
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/workflow">
                            <i class="fas fa-cogs me-1"></i>Workflow
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4">
                        <i class="fas fa-magic text-primary me-3"></i>
                        Content Review
                    </h1>
                    <p class="lead text-muted">Review your AI-generated social media content</p>
                </div>
            </div>
        </div>

        <!-- Generated Image Section -->
        <div class="review-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="fas fa-image text-primary me-2"></i>Generated Images</h3>
                        <button class="btn btn-outline-primary" onclick="editImage()">
                            <i class="fas fa-edit me-1"></i>Edit Image
                        </button>
                    </div>
                    <p class="text-muted">AI-generated visual content for your social media posts</p>
                    <div class="image-comparison" id="image-comparison-container">
                        {% if original_image_url and original_image_url != image_url %}
                        <div class="image-container" id="original-image-container">
                            <h5>Original Image</h5>
                            <div class="image-preview">
                                <img src="{{ original_image_url }}" alt="Original Image" class="image-preview" id="original-image">
                                <div class="image-actions mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editImage()">
                                        <i class="fas fa-edit me-1"></i>Edit Image
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="image-container" id="current-image-container">
                            <h5>Current Image</h5>
                            <div id="generated-images">
                                {% if generated_images and generated_images|length > 0 %}
                                    {% if generated_images|length == 1 %}
                                        <img src="{{ generated_images[0] }}" alt="Generated Image" class="image-preview" id="main-generated-image">
                                    {% else %}
                                        <div class="row">
                                            {% for image_url in generated_images %}
                                                <div class="col-md-6 mb-3">
                                                    <img src="{{ image_url }}" alt="Generated Image {{ loop.index }}" class="image-preview">
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% elif image_url %}
                                    <img src="{{ image_url }}" alt="Generated Image" class="image-preview" id="main-generated-image">
                                {% else %}
                                    <div class="text-center py-5 bg-light rounded">
                                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No image generated</p>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="image-actions mt-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="editImage()">
                                    <i class="fas fa-edit me-1"></i>Edit Image
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="regenerateImage()">
                                    <i class="fas fa-redo me-1"></i>Regenerate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-info-circle me-1"></i>Image Details</h6>
                            <p class="card-text small text-muted">
                                {% if generated_images and generated_images|length > 0 %}
                                    {{ generated_images|length }} image(s) generated using AI based on your content topic and platform requirements.
                                {% else %}
                                    This image was generated using AI based on your content topic and platform requirements.
                                {% endif %}
                            </p>
                            {% if image_context %}
                                <p class="card-text small">
                                    <strong>Context:</strong> {{ image_context }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Content Section -->
        <div class="review-card">
            <h3><i class="fas fa-file-alt text-primary me-2"></i>Generated Content</h3>
            <p class="text-muted">Platform-specific captions and content</p>
            
            {% if content %}
                {% for platform, platform_data_list in content.items() %}
                    {% set platform_data = platform_data_list[0] if platform_data_list and platform_data_list|length > 0 else {} %}
                    <div class="platform-card">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fab fa-{{ platform|lower }} fa-2x text-primary me-3"></i>
                            <div>
                                <h5 class="mb-0">{{ platform|title }}</h5>
                                <small class="text-muted">Platform-specific content</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-comment-dots me-1"></i>Caption:</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="editCaption('{{ platform }}')">
                                    <i class="fas fa-edit me-1"></i>Edit Caption
                                </button>
                            </div>
                            <div class="bg-white p-3 rounded border" id="caption-{{ platform }}" style="cursor: pointer;" onclick="showCaptionModal('{{ platform }}', '{{ platform_data.get('content', platform_data.get('caption', ''))|escape }}')" title="Click to view full caption">
                                {{ platform_data.get('content', platform_data.get('caption', ''))|safe|truncate(150) }}
                            </div>
                        </div>
                        
                        {% if platform_data.hashtags %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6><i class="fas fa-hashtag me-1"></i>Hashtags:</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editHashtags('{{ platform }}')">
                                        <i class="fas fa-edit me-1"></i>Edit Hashtags
                                    </button>
                                </div>
                                <div id="hashtags-{{ platform }}">
                                    {% for hashtag in platform_data.hashtags %}
                                        <span class="hashtag-badge">#{{ hashtag }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if platform_data.call_to_action %}
                            <div class="mb-3">
                                <h6><i class="fas fa-bullhorn me-1"></i>Call to Action:</h6>
                                <div class="alert alert-info">
                                    {{ platform_data.call_to_action }}
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Engagement</small>
                                <div class="fw-bold text-{{ 'success' if analytics and platform in analytics and analytics[platform] and analytics[platform][0].get('engagement_score') and analytics[platform][0].get('engagement_score')|int > 70 else 'warning' if analytics and platform in analytics and analytics[platform] and analytics[platform][0].get('engagement_score') and analytics[platform][0].get('engagement_score')|int > 40 else 'danger' }}">
                                    {% if analytics and platform in analytics and analytics[platform] and analytics[platform][0].get('engagement_score') %}
                                        {{ analytics[platform][0].get('engagement_score') }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Characters</small>
                                <div class="fw-bold">{{ platform_data.get('character_count', platform_data.get('content', '')|length) }}</div>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Tone</small>
                                <div class="fw-bold">{{ tone|title }}</div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No content generated</p>
                </div>
            {% endif %}
        </div>

        <!-- Enhanced Prompt Section -->
        <div class="review-card">
            <h3><i class="fas fa-lightbulb text-warning me-2"></i>Enhanced Prompt</h3>
            <p class="text-muted">AI-enhanced prompt used for content generation</p>
            
            <div class="enhanced-prompt">
                {% if enhanced_prompt %}
                    <div class="mb-3">
                        <strong>Original Prompt:</strong>
                        <div class="bg-light p-2 rounded mt-1 small text-muted" style="font-style: italic;">
                            {{ topic }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Enhanced Prompt:</strong>
                        <div class="bg-light p-3 rounded mt-1">
                            {{ enhanced_prompt }}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-lightbulb fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Enhanced prompt will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="review-card">
            <h3><i class="fas fa-chart-bar text-success me-2"></i>Content Analytics</h3>
            <p class="text-muted">Performance predictions and insights</p>
            
            {% if analytics %}
                {% set first_platform = analytics.keys()|list|first %}
                {% if first_platform and analytics[first_platform] %}
                    {% set first_analytics = analytics[first_platform][0] %}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="analytics-metric text-center">
                                <div class="analytics-label text-uppercase text-muted small mb-1">Engagement Score</div>
                                <div class="analytics-value h4 mb-0 text-primary">
                                    {% if first_analytics.engagement_score %}
                                        {{ first_analytics.engagement_score }}%
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="analytics-metric text-center">
                                <div class="analytics-label text-uppercase text-muted small mb-1">Viral Potential</div>
                                <div class="analytics-value h4 mb-0 text-success">
                                    {% if first_analytics.viral_potential %}
                                        {{ first_analytics.viral_potential|capitalize }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="analytics-metric text-center">
                                <div class="analytics-label text-uppercase text-muted small mb-1">Best Time to Post</div>
                                <div class="analytics-value h4 mb-0 text-info">
                                    {% if first_analytics.best_posting_time %}
                                        {{ first_analytics.best_posting_time }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if first_analytics.improvements %}
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-lightbulb me-2"></i>Suggested Improvements
                            </h6>
                            <div class="row">
                                {% for improvement in first_analytics.improvements %}
                                    <div class="col-md-6 mb-2">
                                        <div class="improvement-item p-2 bg-light rounded">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            {{ improvement }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if first_analytics.strengths or first_analytics.weaknesses %}
                        <div class="row mt-4">
                            {% if first_analytics.strengths %}
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-thumbs-up text-success me-2"></i>Strengths
                                    </h6>
                                    <ul class="list-unstyled">
                                        {% for strength in first_analytics.strengths %}
                                            <li class="mb-1">
                                                <i class="fas fa-check text-success me-2"></i>{{ strength }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            {% if first_analytics.weaknesses %}
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Areas for Improvement
                                    </h6>
                                    <ul class="list-unstyled">
                                        {% for weakness in first_analytics.weaknesses %}
                                            <li class="mb-1">
                                                <i class="fas fa-arrow-up text-warning me-2"></i>{{ weakness }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Analytics will be available after content generation.</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Analytics will be available after content generation.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Scheduling Options -->
    <div class="container">
        <div class="review-card">
            <h4><i class="fas fa-clock text-primary me-2"></i>Scheduling Options</h4>
            <p class="text-muted">Choose when to publish your content</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="schedulingOption" id="publishNow" value="publishNow" checked>
                        <label class="form-check-label" for="publishNow">
                            <strong>Publish Now</strong>
                            <br><small class="text-muted">Post immediately to all selected platforms</small>
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="schedulingOption" id="scheduleFor" value="scheduleFor">
                        <label class="form-check-label" for="scheduleFor">
                            <strong>Schedule for Later</strong>
                            <br><small class="text-muted">Choose a specific date and time</small>
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="scheduleDateTimeContainer" class="d-none">
                <div class="row">
                    <div class="col-md-6">
                        <label for="scheduleDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate">
                    </div>
                    <div class="col-md-6">
                        <label for="scheduleTime" class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Format: YYYY-MM-DDTHH:MM:SS (e.g., 2024-01-01T12:00:00)</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="container">
        <div class="action-buttons">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Creation
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="regenerateContent(event)">
                        <i class="fas fa-redo me-2"></i>Regenerate
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" onclick="publishContent(event)">
                        <i class="fas fa-paper-plane me-2"></i>Publish Content
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container text-center">
            <p>&copy; 2024 AutoSocioly. Powered by AI.</p>
        </div>
    </footer>

    <!-- Caption View Modal -->
    <div class="modal fade" id="captionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Full Caption</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Platform:</label>
                        <span id="captionPlatform" class="badge bg-primary"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Caption:</label>
                        <div class="p-3 bg-light rounded" id="fullCaption" style="white-space: pre-wrap; font-family: inherit;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Character Count:</label>
                        <span id="captionLength" class="text-muted"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyCaption()">Copy Caption</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Edit Modal -->
    <div class="modal fade" id="imageEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="image-edit-prompt" class="form-label">Describe how you want to modify the image:</label>
                        <textarea class="form-control" id="image-edit-prompt" rows="3" 
                                  placeholder="e.g., 'Make it more colorful', 'Add a professional background', 'Change the style to minimalist'"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Your original image will be used as a reference. Describe the changes you want to make.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitImageEdit()">
                        <i class="fas fa-magic me-2"></i>Regenerate Image
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store workflow data
        const workflowData = {
            workflow_id: {{ workflow_id|tojson if workflow_id else 'null' }},
            topic: {{ topic|tojson if topic else '""' }},
            platforms: {{ platforms|tojson if platforms else '[]' }},
            tone: {{ tone|tojson if tone else '""' }},
            content: {{ content|tojson if content else '{}' }},
            image_url: {{ image_url|tojson if image_url else '""' }}
        };

        // Global function definitions - moved outside DOMContentLoaded to ensure availability
        function regenerateContent(event) {
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Regenerating...';
            btn.disabled = true;

            // Redirect back to creation page with current data
            const formData = new FormData();
            formData.append('topic', workflowData.topic);
            workflowData.platforms.forEach(platform => {
                formData.append('platforms', platform);
            });
            formData.append('tone', workflowData.tone);
            formData.append('include_image', 'true');

            // Submit form to regenerate
            fetch('/create-content', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Reload page with new content
                    window.location.reload();
                } else {
                    alert('Error regenerating content: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error regenerating content');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function publishContent(event) {
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Publishing...';
            btn.disabled = true;

            // Get scheduling option
            const schedulingOption = document.querySelector('input[name="schedulingOption"]:checked').value;
            let scheduledFor = null;
            
            if (schedulingOption === 'scheduleFor') {
                const scheduleDate = document.getElementById('scheduleDate').value;
                const scheduleTime = document.getElementById('scheduleTime').value;
                
                if (!scheduleDate || !scheduleTime) {
                    alert('Please select both date and time for scheduling');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Combine date and time into ISO format (YYYY-MM-DDTHH:MM:SS)
                scheduledFor = `${scheduleDate}T${scheduleTime}:00`;
                
                // Validate the datetime format
                const dateObj = new Date(scheduledFor);
                if (isNaN(dateObj.getTime())) {
                    alert('Invalid date/time format. Please check your selection.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                // Check if scheduled time is in the past
                if (dateObj <= new Date()) {
                    alert('Scheduled time must be in the future');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            // Prepare publish data - create selected_variants from available platforms
            const formData = new FormData();
            formData.append('workflow_id', workflowData.workflow_id);
            
            // Add scheduling information
            if (schedulingOption === 'publishNow') {
                formData.append('publishNow', 'true');
            } else {
                formData.append('scheduledFor', scheduledFor);
            }
            
            // Add all available platforms as selected variants
            // Backend expects selected_variants to be a dict with platform names as keys
            const selectedVariants = {};
            workflowData.platforms.forEach(platform => {
                selectedVariants[platform] = true;  // Mark each platform as selected
            });
            
            // Convert selectedVariants to FormData format
            Object.keys(selectedVariants).forEach(platform => {
                formData.append(`selected_variants[${platform}]`, 'true');
            });

            // Publish content
            fetch('/publish-content', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Show success message
                    alert('Content published successfully!');
                    // Optionally redirect to success page or dashboard
                } else {
                    alert('Error publishing content: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error publishing content');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function copyCaption(event) {
            const captionText = document.getElementById('fullCaption').textContent;
            navigator.clipboard.writeText(captionText).then(function() {
                // Show success feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                }, 2000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
            });
        }

        function showCaptionModal(platform, caption) {
            document.getElementById('captionPlatform').textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
            document.getElementById('fullCaption').textContent = caption;
            document.getElementById('captionLength').textContent = caption.length + ' characters';
            
            const modal = new bootstrap.Modal(document.getElementById('captionModal'));
            modal.show();
        }

        function editCaption(platform) {
            const currentCaption = document.getElementById(`caption-${platform}`).textContent.trim();
            const newCaption = prompt('Edit caption:', currentCaption);
            if (newCaption !== null && newCaption !== currentCaption) {
                updateContent(platform, 'content', newCaption);
            }
        }

        function editHashtags(platform) {
            const currentHashtags = Array.from(document.querySelectorAll(`#hashtags-${platform} .hashtag-badge`))
                .map(tag => tag.textContent.replace('#', ''))
                .join(', ');
            const newHashtags = prompt('Edit hashtags (comma-separated):', currentHashtags);
            if (newHashtags !== null && newHashtags !== currentHashtags) {
                updateContent(platform, 'hashtags', newHashtags.split(',').map(tag => tag.trim()));
            }
        }

        function editImage() {
            // Show the modal first
            const modal = new bootstrap.Modal(document.getElementById('imageEditModal'));
            modal.show();
        }

        function submitImageEdit() {
            const modal = document.getElementById('imageEditModal');
            const textarea = modal.querySelector('textarea');
            const prompt = textarea.value.trim();
            
            if (!prompt) {
                alert('Please enter a description for the image modification');
                return;
            }
            
            // Get original image URL for context
            const originalImage = document.querySelector('#generated-images img');
            const originalImageUrl = originalImage ? originalImage.src : '{{ image_url }}';
            
            // Close modal
            bootstrap.Modal.getInstance(modal).hide();
            
            // Show loading state
            const button = document.querySelector('[onclick="editImage()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Regenerating...';
            button.disabled = true;
            
            fetch('/regenerate-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    workflow_id: '{{ workflow_id }}',
                    prompt: prompt,
                    original_image_url: originalImageUrl
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the image display with the new image
                    const generatedImagesContainer = document.getElementById('generated-images');
                    if (generatedImagesContainer) {
                        // Clear existing images
                        generatedImagesContainer.innerHTML = '';
                        
                        // Add new image
                        const newImage = document.createElement('img');
                        newImage.src = result.image_url;
                        newImage.alt = 'Regenerated Image';
                        newImage.className = 'image-preview';
                        newImage.id = 'main-generated-image';
                        
                        generatedImagesContainer.appendChild(newImage);
                        
                        // Store the new image URL for future reference
                        if (!window.generatedImages) {
                            window.generatedImages = [];
                        }
                        window.generatedImages = [result.image_url];
                    }
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check"></i> Image regenerated successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    generatedImagesContainer.parentNode.insertBefore(alertDiv, generatedImagesContainer.nextSibling);
                } else {
                    throw new Error(result.detail || 'Failed to regenerate image');
                }
            })
            .catch(error => {
                console.error('Error regenerating image:', error);
                
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> Error regenerating image: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('generated-images').parentNode.insertBefore(alertDiv, document.getElementById('generated-images').nextSibling);
            })
            .finally(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                
                // Clear textarea
                textarea.value = '';
            });
        }

        function updateContent(platform, field, value) {
            const formData = new FormData();
            formData.append('workflow_id', workflowData.workflow_id);
            formData.append('platform', platform);
            formData.append('field', field);
            formData.append('value', typeof value === 'string' ? value : JSON.stringify(value));

            fetch('/edit-content', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the UI
                    if (field === 'caption') {
                        document.getElementById(`caption-${platform}`).innerHTML = value;
                    } else if (field === 'hashtags') {
                        const hashtagsDiv = document.getElementById(`hashtags-${platform}`);
                        hashtagsDiv.innerHTML = value.map(tag => 
                            `<span class="hashtag-badge">#${tag}</span>`
                        ).join('');
                    }
                } else {
                    alert('Error updating content: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating content');
            });
        }

        // Add copy functionality for captions
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date/time values for scheduling
            const now = new Date();
            now.setHours(now.getHours() + 1); // Default to 1 hour from now
            
            const dateInput = document.getElementById('scheduleDate');
            const timeInput = document.getElementById('scheduleTime');
            
            if (dateInput) dateInput.value = now.toISOString().split('T')[0];
            if (timeInput) timeInput.value = now.toTimeString().slice(0, 5);
            
            // Add event listeners for scheduling options
            const publishNowRadio = document.getElementById('publishNow');
            const scheduleForRadio = document.getElementById('scheduleFor');
            const scheduleContainer = document.getElementById('scheduleDateTimeContainer');
            
            function toggleScheduleContainer() {
                if (scheduleForRadio.checked) {
                    scheduleContainer.classList.remove('d-none');
                } else {
                    scheduleContainer.classList.add('d-none');
                }
            }
            
            if (publishNowRadio) publishNowRadio.addEventListener('change', toggleScheduleContainer);
            if (scheduleForRadio) scheduleForRadio.addEventListener('change', toggleScheduleContainer);

            // Add copy buttons to captions
            const captions = document.querySelectorAll('.bg-white.p-3.rounded.border');
            captions.forEach(caption => {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary float-end';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(caption.textContent.trim());
                    copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 2000);
                };
                caption.appendChild(copyBtn);
            });
        });

        // Edit functions are now defined globally above
    </script>
</body>
</html>